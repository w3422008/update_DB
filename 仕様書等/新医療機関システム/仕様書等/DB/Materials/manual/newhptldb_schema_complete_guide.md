# æ–°åŒ»ç™‚æ©Ÿé–¢ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ å®Œå…¨è§£èª¬ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡
1. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦)
2. [ğŸ”§ é«˜åº¦ãªæŠ€è¡“ä»•æ§˜ ç´¢å¼•](#é«˜åº¦ãªæŠ€è¡“ä»•æ§˜-ç´¢å¼•)
   - [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®Œå…¨ãƒªã‚¹ãƒˆ](#ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®Œå…¨ãƒªã‚¹ãƒˆ)
   - [ãƒˆãƒªã‚¬ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ](#ãƒˆãƒªã‚¬ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ)  
   - [ãƒ“ãƒ¥ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ](#ãƒ“ãƒ¥ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ)
   - [ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ»é–¢æ•°å®Œå…¨ãƒªã‚¹ãƒˆ](#ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ»é–¢æ•°å®Œå…¨ãƒªã‚¹ãƒˆ)
   - [å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å®Œå…¨ãƒªã‚¹ãƒˆ](#å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å®Œå…¨ãƒªã‚¹ãƒˆ)
   - [ENUMå‹å®šç¾©å®Œå…¨ãƒªã‚¹ãƒˆ](#enumå‹å®šç¾©å®Œå…¨ãƒªã‚¹ãƒˆ)
3. [ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆä¸€è¦§](#ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆä¸€è¦§)
4. [å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°è§£èª¬](#å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°è§£èª¬)
5. [ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªä¾‹](#ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªä¾‹)
6. [é‹ç”¨ãƒ»ä¿å®ˆã‚¬ã‚¤ãƒ‰](#é‹ç”¨ãƒ»ä¿å®ˆã‚¬ã‚¤ãƒ‰)

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å**: `newhptldb`
**æ–‡å­—ã‚»ãƒƒãƒˆ**: `utf8mb4`
**ç…§åˆé †åº**: `utf8mb4_general_ci`
**ã‚¨ãƒ³ã‚¸ãƒ³**: InnoDBï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

### ä¸»è¦ãªæ©Ÿèƒ½
- **åŒ»ç™‚æ©Ÿé–¢æƒ…å ±ã®çµ±åˆç®¡ç†**
- **çµ±åˆãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆç›£æŸ»ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ï¼‰
- **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†**
- **å•ã„åˆã‚ã›ãƒ»è¦æœ›ç®¡ç†**
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**

---

## ğŸ”§ é«˜åº¦ãªæŠ€è¡“ä»•æ§˜ ç´¢å¼•

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆå­¦è€…ã«ã¨ã£ã¦ç†è§£ãŒå›°é›£ãªé«˜åº¦ãªæŠ€è¡“è¦ç´ ã‚’å®Œå…¨ã«ãƒªã‚¹ãƒˆåŒ–ã—ã€å®Ÿè£…å†…å®¹ã¨ä½¿ç”¨æ–¹æ³•ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®Œå…¨ãƒªã‚¹ãƒˆ

#### ğŸ¯ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ17å€‹ï¼‰**

| # | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å | å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ« | å¯¾è±¡ã‚«ãƒ©ãƒ  | ç”¨é€”ãƒ»åŠ¹æœ |
|---|--------------|-------------|-----------|-----------|
| 1 | `idx_maintenance_date` | maintenance | date | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ—¥ã§ã®é«˜é€Ÿæ¤œç´¢ |
| 2 | `idx_maintenance_view` | maintenance | view | è¡¨ç¤ºå¯¾è±¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®çµã‚Šè¾¼ã¿ |
| 3 | `idx_maintenance_created_by` | maintenance | created_by | ä½œæˆè€…ã«ã‚ˆã‚‹æ¤œç´¢æœ€é©åŒ– |
| 4 | `idx_maintenance_start_maintenance_id` | maintenance_start | maintenance_id | é–¢é€£ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã®é«˜é€Ÿçµåˆ |
| 5 | `idx_maintenance_start_view` | maintenance_start | view | å®Ÿè¡Œä¸­é€šçŸ¥ã®è¡¨ç¤ºåˆ¶å¾¡ |
| 6 | `idx_system_versions_is_current` | system_versions | is_current | ç¾åœ¨ç¨¼åƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¬æ™‚æ¤œç´¢ |
| 7 | `idx_system_versions_release_date` | system_versions | release_date | ãƒªãƒªãƒ¼ã‚¹æ—¥é †ã‚½ãƒ¼ãƒˆæœ€é©åŒ– |
| 8 | `idx_message_status` | message | status | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢ã®é«˜é€ŸåŒ– |
| 9 | `idx_message_priority` | message | priority | å„ªå…ˆåº¦ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿æœ€é©åŒ– |
| 10 | `idx_message_assigned_to` | message | assigned_to | æ‹…å½“è€…åˆ¥ä¸€è¦§è¡¨ç¤ºã®é«˜é€ŸåŒ– |
| 11 | `idx_message_version_id` | message | version_id | ãƒãƒ¼ã‚¸ãƒ§ãƒ³é–¢é€£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢ |
| 12 | `idx_message_created_at` | message | created_at | æ™‚ç³»åˆ—æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆã®æœ€é©åŒ– |
| 13 | `idx_system_status_system_mode` | system_status | system_mode | ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šã®é«˜é€ŸåŒ– |
| 14 | `idx_system_status_maintenance_id` | system_status | maintenance_id | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–¢é€£çŠ¶æ…‹ã®æ¤œç´¢ |
| 15 | `idx_system_status_created_at` | system_status | created_at | çŠ¶æ…‹å±¥æ­´ã®æ™‚ç³»åˆ—æ¤œç´¢ |
| 16 | `idx_inquires_user_id` | inquires | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å•ã„åˆã‚ã›æ¤œç´¢ |
| 17 | `idx_inquires_status` | inquires | status | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥å•ã„åˆã‚ã›åˆ†é¡ |
| 18 | `idx_inquires_priority` | inquires | priority | å„ªå…ˆåº¦åˆ¥å•ã„åˆã‚ã›æŠ½å‡º |
| 19 | `idx_inquires_assigned_to` | inquires | assigned_to | æ‹…å½“è€…åˆ¥å•ã„åˆã‚ã›ç®¡ç† |
| 20 | `idx_inquires_created_at` | inquires | created_at | å•ã„åˆã‚ã›å—ä»˜æ—¥æ™‚æ¤œç´¢ |

#### ğŸ“– **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ä¾‹**

```sql
-- é«˜é€Ÿæ¤œç´¢ã®ä¾‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ï¼‰
-- 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šã®åŠ¹ç‡çš„ãªæ¤œç´¢
SELECT * FROM maintenance 
WHERE date >= CURDATE() AND view = true;  -- idx_maintenance_date, idx_maintenance_viewä½¿ç”¨

-- 2. ç¾åœ¨ç¨¼åƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¬æ™‚å–å¾—
SELECT * FROM system_versions 
WHERE is_current = true;  -- idx_system_versions_is_currentä½¿ç”¨

-- 3. å„ªå…ˆåº¦ã®é«˜ã„æœªå¯¾å¿œå•ã„åˆã‚ã›ã®é«˜é€ŸæŠ½å‡º
SELECT * FROM inquires 
WHERE status = 'open' AND priority = 'urgent';  -- idx_inquires_status, idx_inquires_priorityä½¿ç”¨

-- 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœã®ç¢ºèªæ–¹æ³•
EXPLAIN SELECT * FROM maintenance WHERE date >= CURDATE();
-- â†’ key: idx_maintenance_date ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
```

---

### ãƒˆãƒªã‚¬ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ

#### ğŸ” **è‡ªå‹•ç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ24å€‹ã®ãƒˆãƒªã‚¬ãƒ¼ï¼‰**

ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’è‡ªå‹•çš„ã«`unified_logs`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã™ã‚‹ç›£æŸ»ãƒˆãƒªã‚¬ãƒ¼

| # | ãƒˆãƒªã‚¬ãƒ¼å | å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚¤ãƒ™ãƒ³ãƒˆ | å‹•ä½œå†…å®¹ |
|---|------------|-------------|----------|----------|
| **1** | `hospitals_insert_audit` | hospitals | INSERT | åŒ»ç™‚æ©Ÿé–¢æ–°è¦è¿½åŠ ã®è¨˜éŒ² |
| **2** | `hospitals_update_audit` | hospitals | UPDATE | åŒ»ç™‚æ©Ÿé–¢æƒ…å ±å¤‰æ›´ã®è¿½è·¡ |
| **3** | `hospitals_delete_audit` | hospitals | DELETE | åŒ»ç™‚æ©Ÿé–¢å‰Šé™¤ã®è¨˜éŒ² |
| **4** | `users_insert_audit` | users | INSERT | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆã®è¨˜éŒ² |
| **5** | `users_update_audit` | users | UPDATE | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¤‰æ›´ã®è¿½è·¡ |
| **6** | `users_delete_audit` | users | DELETE | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®è¨˜éŒ² |
| **7** | `contact_details_insert_audit` | contact_details | INSERT | é€£çµ¡å…ˆæƒ…å ±è¿½åŠ ã®è¨˜éŒ² |
| **8** | `contact_details_update_audit` | contact_details | UPDATE | é€£çµ¡å…ˆå¤‰æ›´ã®è¿½è·¡ |
| **9** | `contact_details_delete_audit` | contact_details | DELETE | é€£çµ¡å…ˆå‰Šé™¤ã®è¨˜éŒ² |
| **10** | `hospital_staffs_insert_audit` | hospital_staffs | INSERT | ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±è¿½åŠ ã®è¨˜éŒ² |
| **11** | `hospital_staffs_update_audit` | hospital_staffs | UPDATE | ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±å¤‰æ›´ã®è¿½è·¡ |
| **12** | `hospital_staffs_delete_audit` | hospital_staffs | DELETE | ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã®è¨˜éŒ² |
| **13** | `introductions_insert_audit` | introductions | INSERT | ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã®è¨˜éŒ² |
| **14** | `introductions_update_audit` | introductions | UPDATE | ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®è¿½è·¡ |
| **15** | `introductions_delete_audit` | introductions | DELETE | ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®è¨˜éŒ² |
| **16** | `maintenance_insert_audit` | maintenance | INSERT | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šè¿½åŠ ã®è¨˜éŒ² |
| **17** | `maintenance_update_audit` | maintenance | UPDATE | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šå¤‰æ›´ã®è¿½è·¡ |
| **18** | `maintenance_delete_audit` | maintenance | DELETE | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šå‰Šé™¤ã®è¨˜éŒ² |
| **19** | `message_insert_audit` | message | INSERT | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ ã®è¨˜éŒ² |
| **20** | `message_update_audit` | message | UPDATE | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´ã®è¿½è·¡ |
| **21** | `message_delete_audit` | message | DELETE | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã®è¨˜éŒ² |
| **22** | `system_status_insert_audit` | system_status | INSERT | ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹å¤‰æ›´ã®è¨˜éŒ² |
| **23** | `system_status_update_audit` | system_status | UPDATE | ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°ã®è¿½è·¡ |
| **24** | `inquires_insert_audit` | inquires | INSERT | å•ã„åˆã‚ã›è¿½åŠ ã®è¨˜éŒ² |
| **25** | `inquires_update_audit` | inquires | UPDATE | å•ã„åˆã‚ã›å¤‰æ›´ã®è¿½è·¡ |
| **26** | `inquires_delete_audit` | inquires | DELETE | å•ã„åˆã‚ã›å‰Šé™¤ã®è¨˜éŒ² |

#### ğŸ“– **ãƒˆãƒªã‚¬ãƒ¼ã®ä»•çµ„ã¿ã¨ç¢ºèªæ–¹æ³•**

```sql
-- ãƒˆãƒªã‚¬ãƒ¼ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã‹ã®ä¾‹

-- 1. ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹
UPDATE hospitals SET hospital_name = 'æ–°ã—ã„ç—…é™¢å' WHERE hospital_id = 'H001';
-- â†’ hospitals_update_audit ãƒˆãƒªã‚¬ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œ
-- â†’ unified_logsãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›´å±¥æ­´ãŒè‡ªå‹•è¨˜éŒ²

-- 2. ç›£æŸ»ãƒ­ã‚°ã®ç¢ºèª
SELECT 
    table_name,
    record_id,
    action_type,
    JSON_EXTRACT(old_values, '$.hospital_name') as old_name,
    JSON_EXTRACT(new_values, '$.hospital_name') as new_name,
    created_at
FROM unified_logs 
WHERE log_type = 'audit' 
  AND table_name = 'hospitals'
ORDER BY created_at DESC;

-- 3. ç‰¹å®šãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒˆãƒªã‚¬ãƒ¼ä¸€è¦§ç¢ºèª
SHOW TRIGGERS LIKE 'hospitals%';

-- 4. ãƒˆãƒªã‚¬ãƒ¼ã®è©³ç´°ç¢ºèª
SHOW CREATE TRIGGER hospitals_update_audit;
```

#### âš ï¸ **ãƒˆãƒªã‚¬ãƒ¼ä½¿ç”¨æ™‚ã®æ³¨æ„ç‚¹**

- **è‡ªå‹•å®Ÿè¡Œ**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«å¿…ãšå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆåœæ­¢ä¸å¯ï¼‰
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿**: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã¯å‡¦ç†æ™‚é–“ãŒå¢—åŠ 
- **ã‚¨ãƒ©ãƒ¼é€£é–**: ãƒˆãƒªã‚¬ãƒ¼å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¨å…ƒã®å‡¦ç†ã‚‚å¤±æ•—
- **ãƒ‡ãƒãƒƒã‚°å›°é›£**: è¦‹ãˆãªã„å‡¦ç†ã®ãŸã‚ã€å•é¡Œç‰¹å®šãŒå›°é›£ãªå ´åˆãŒã‚ã‚‹

---

### ãƒ“ãƒ¥ãƒ¼å®Œå…¨ãƒªã‚¹ãƒˆ

#### ğŸ¬ **ä»®æƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ“ãƒ¥ãƒ¼ï¼‰ã«ã‚ˆã‚‹é«˜åº¦ãªãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆ13å€‹ï¼‰**

| # | ãƒ“ãƒ¥ãƒ¼å | ç”¨é€” | ä¸»è¦ãªçµåˆãƒ†ãƒ¼ãƒ–ãƒ« | è¤‡é›‘åº¦ |
|---|---------|------|------------------|--------|
| **1** | `audit_summary` | ç›£æŸ»ãƒ­ã‚°çµ±è¨ˆ | unified_logs | â­ |
| **2** | `access_summary` | ã‚¢ã‚¯ã‚»ã‚¹çµ±è¨ˆ | unified_logs | â­â­ |
| **3** | `security_alerts` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ | unified_logs + users | â­â­ |
| **4** | `user_activity` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•çŠ¶æ³ | users + unified_logs | â­â­â­ |
| **5** | `current_system_status` | ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ | system_status + users + facilities + departments + maintenance | â­â­â­â­ |
| **6** | `current_version` | ç¾åœ¨ç¨¼åƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ | system_versions | â­ |
| **7** | `maintenance_schedule` | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | maintenance + users + facilities + departments | â­â­â­â­ |
| **8** | `message_management` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è¦æœ›ç®¡ç† | message + users + facilities + departments + system_versions | â­â­â­â­â­ |
| **9** | `version_statistics` | ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±è¨ˆ | system_versions + message | â­â­â­ |
| **10** | `inquire_management` | å•ã„åˆã‚ã›ç®¡ç† | inquires + users + facilities + departments | â­â­â­â­ |
| **11** | `inquire_statistics` | å•ã„åˆã‚ã›çµ±è¨ˆ | inquires | â­â­ |
| **12** | `system_usage_stats` | ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çµ±è¨ˆ | unified_logs | â­â­ |

#### ğŸ“– **ãƒ“ãƒ¥ãƒ¼ã®é«˜åº¦ãªæ©Ÿèƒ½ä¾‹**

```sql
-- è¤‡é›‘ãªé›†è¨ˆå‡¦ç†ã‚’ç°¡å˜ã«å®Ÿè¡Œ
-- 1. ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¬æ™‚ã«ç¢ºèª
SELECT * FROM current_system_status;
-- â†’ 5ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ãŸè¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’1è¡Œã§å®Ÿè¡Œ

-- 2. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®š
SELECT title, status, maintenance_start, maintenance_end 
FROM maintenance_schedule 
WHERE status IN ('å®Ÿè¡Œä¸­', 'æœ¬æ—¥äºˆå®š');

-- 3. å•ã„åˆã‚ã›ã®è©³ç´°ç®¡ç†æƒ…å ±
SELECT 
    inquire_id,
    priority,
    status,
    inquirer_name,
    inquirer_facility,
    response_time_hours,
    days_since_created
FROM inquire_management 
WHERE status = 'open'
ORDER BY priority DESC, days_since_created DESC;

-- 4. ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çµ±è¨ˆã®å¯è¦–åŒ–
SELECT 
    usage_date,
    unique_users,
    login_count,
    security_alerts
FROM system_usage_stats
ORDER BY usage_date DESC
LIMIT 7;  -- éå»1é€±é–“ã®ãƒ‡ãƒ¼ã‚¿
```

#### ğŸ”¬ **ãƒ“ãƒ¥ãƒ¼ã®é«˜åº¦ãªæŠ€è¡“è¦ç´ **

```sql
-- CASEæ–‡ã‚’ä½¿ã£ãŸå‹•çš„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šä¾‹ï¼ˆmaintenance_scheduleãƒ“ãƒ¥ãƒ¼ã‚ˆã‚Šï¼‰
CASE 
    WHEN m.date < CURDATE() THEN 'å®Œäº†'
    WHEN m.date = CURDATE() AND CURTIME() BETWEEN COALESCE(m.start_time, '00:00:00') AND COALESCE(m.end_time, '23:59:59') THEN 'å®Ÿè¡Œä¸­'
    WHEN m.date = CURDATE() AND CURTIME() < COALESCE(m.start_time, '00:00:00') THEN 'æœ¬æ—¥äºˆå®š'
    WHEN m.date > CURDATE() THEN 'äºˆå®š'
    ELSE 'å®Œäº†'
END as status

-- é›†ç´„é–¢æ•°ã¨CASEæ–‡ã®çµ„ã¿åˆã‚ã›ä¾‹ï¼ˆinquire_statisticsãƒ“ãƒ¥ãƒ¼ã‚ˆã‚Šï¼‰
COUNT(CASE WHEN status = 'open' THEN 1 END) as open_inquiries,
COUNT(CASE WHEN priority = 'urgent' THEN 1 END) as urgent_inquiries,
AVG(CASE 
    WHEN status = 'resolved' AND resolved_at IS NOT NULL THEN 
        TIMESTAMPDIFF(HOUR, created_at, resolved_at)
END) as avg_resolution_time_hours
```

---

### ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ»é–¢æ•°å®Œå…¨ãƒªã‚¹ãƒˆ

#### âš™ï¸ **å†åˆ©ç”¨å¯èƒ½ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ4å€‹ï¼‰**

| # | åå‰ | ç¨®åˆ¥ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æˆ»ã‚Šå€¤ | ç”¨é€”ãƒ»æ©Ÿèƒ½ |
|---|------|------|----------|--------|-----------|
| **1** | `get_current_version()` | é–¢æ•° | ãªã— | VARCHAR(20) | ç¾åœ¨ç¨¼åƒä¸­ã®ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾— |
| **2** | `switch_current_version(version_id)` | ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ | INT | ãªã— | ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å®‰å…¨ãªåˆ‡ã‚Šæ›¿ãˆ |
| **3** | `escalate_urgent_inquiries()` | ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ | ãªã— | ãªã— | ç·Šæ€¥å•ã„åˆã‚ã›ã®è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† |
| **4** | `update_inquire_status()` | ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ | 4å€‹ | ãªã— | å•ã„åˆã‚ã›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¸€æ‹¬æ›´æ–°ãƒ»å±¥æ­´è¨˜éŒ² |

#### ğŸ“– **é«˜åº¦ãªãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å®Ÿè£…ä¾‹**

```sql
-- 1. é–¢æ•°ã®ä½¿ç”¨ä¾‹ï¼šç¾åœ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å–å¾—
SELECT 
    get_current_version() as current_version,
    NOW() as check_time;
-- çµæœä¾‹: current_version='4.5.2', check_time='2024-01-24 10:30:00'

-- 2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆã®å®‰å…¨å®Ÿè¡Œ
CALL switch_current_version(5);
-- â†’ è‡ªå‹•çš„ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œï¼š
--   â‘  æŒ‡å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
--   â‘¡ å…¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®is_currentã‚’ç„¡åŠ¹åŒ–
--   â‘¢ æŒ‡å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿æœ‰åŠ¹åŒ–
--   â‘£ ç›£æŸ»ãƒ­ã‚°ã¸ã®è¨˜éŒ²

-- 3. ç·Šæ€¥å•ã„åˆã‚ã›ã®è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
CALL escalate_urgent_inquiries();
-- â†’ è‡ªå‹•å®Ÿè¡Œå†…å®¹ï¼š
--   â‘  24æ™‚é–“ä»¥ä¸Šæœªå¯¾å¿œã®ç·Šæ€¥å•ã„åˆã‚ã› â†’ 'in_progress'ã¸ç§»è¡Œ
--   â‘¡ 72æ™‚é–“ä»¥ä¸Šæœªå¯¾å¿œã®ä¸€èˆ¬å•ã„åˆã‚ã› â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã¸è¨˜éŒ²

-- 4. å•ã„åˆã‚ã›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è©³ç´°æ›´æ–°
CALL update_inquire_status(123, 'resolved', 'è§£æ±ºå®Œäº†ã—ã¾ã—ãŸ', 'ADMIN001');
-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¬æ˜ï¼š
--   123: å•ã„åˆã‚ã›ID
--   'resolved': æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  
--   'è§£æ±ºå®Œäº†ã—ã¾ã—ãŸ': è§£æ±ºå†…å®¹
--   'ADMIN001': æ‹…å½“è€…ID
```

#### ğŸ”§ **ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®é«˜åº¦ãªæŠ€è¡“è¦ç´ **

```sql
-- DECLAREæ–‡ã«ã‚ˆã‚‹å¤‰æ•°å®£è¨€ä¾‹
DECLARE version_exists INT DEFAULT 0;
DECLARE old_status ENUM('open','in_progress','resolved','closed');

-- æ¡ä»¶åˆ†å²å‡¦ç†ã®ä¾‹
IF version_exists > 0 THEN
    -- è¤‡æ•°ã®SQLæ–‡ã‚’é †æ¬¡å®Ÿè¡Œ
    UPDATE system_versions SET is_current = false;
    UPDATE system_versions SET is_current = true WHERE version_id = new_version_id;
    INSERT INTO unified_logs (...) VALUES (...);
END IF;

-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
    ROLLBACK;
    RESIGNAL;
END;
```

---

### å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å®Œå…¨ãƒªã‚¹ãƒˆ

#### ğŸ”— **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ25å€‹ã®åˆ¶ç´„ï¼‰**

| # | åˆ¶ç´„å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ« | å¤–éƒ¨ã‚­ãƒ¼ã‚«ãƒ©ãƒ  | å‚ç…§ãƒ†ãƒ¼ãƒ–ãƒ« | å‚ç…§ã‚«ãƒ©ãƒ  | åˆ¶ç´„ã®åŠ¹æœ |
|---|----------------|---------------|-------------|-----------|-----------|
| **1** | hospitals | hospital_type_id | hospital_types | type_id | ç—…é™¢åŒºåˆ†ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **2** | addresses | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **3** | addresses | area_id | areas | area_id | åœ°åŸŸãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **4** | contact_details | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **5** | hospitals_ward_types | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **6** | hospitals_ward_types | ward_id | ward_types | ward_id | ç—…æ£Ÿç¨®é¡ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **7** | hospital_staffs | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **8** | consultation_hours | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **9** | hospital_departments | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **10** | hospital_departments | department_id | medical_departments | department_id | è¨ºç™‚ç§‘ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **11** | hospital_services | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **12** | clinical_pathway_hospitals | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **13** | clinical_pathway_hospitals | clinical_pathway_id | clinical_pathways | clinical_pathway_id | é€£æºãƒ‘ã‚¹ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **14** | users | facility_id | kawasaki_university_facilities | facility_id | æ–½è¨­ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **15** | users | department_id | kawasaki_university_departments | department_id | éƒ¨ç½²ãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **16** | unified_logs | user_id | users | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ä¿è¨¼ |
| **17** | introductions | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **18** | introductions | user_id | users | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ä¿è¨¼ |
| **19** | training | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **20** | training | user_id | users | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ä¿è¨¼ |
| **21** | training | position_id | positions | position_id | è·åãƒã‚¹ã‚¿ã¨ã®æ•´åˆæ€§ä¿è¨¼ |
| **22** | contacts | hospital_id | hospitals | hospital_id | åŒ»ç™‚æ©Ÿé–¢ã®å­˜åœ¨ä¿è¨¼ |
| **23** | contacts | user_id | users | user_id | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ä¿è¨¼ |
| **24** | inquires | user_id | users | user_id | å•ã„åˆã‚ã›è€…ã®å­˜åœ¨ä¿è¨¼ |
| **25** | inquires | assigned_to | users | user_id | æ‹…å½“è€…ã®å­˜åœ¨ä¿è¨¼ |
| **26** | maintenance | created_by | users | user_id | ä½œæˆè€…ã®å­˜åœ¨ä¿è¨¼ |
| **27** | maintenance_start | maintenance_id | maintenance | maintenance_id | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šã®å­˜åœ¨ä¿è¨¼ |
| **28** | maintenance_start | created_by | users | user_id | ä½œæˆè€…ã®å­˜åœ¨ä¿è¨¼ |
| **29** | message | version_id | system_versions | version_id | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å­˜åœ¨ä¿è¨¼ |
| **30** | message | assigned_to | users | user_id | æ‹…å½“è€…ã®å­˜åœ¨ä¿è¨¼ |
| **31** | system_status | maintenance_id | maintenance | maintenance_id | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šã®å­˜åœ¨ä¿è¨¼ |
| **32** | system_status | changed_by | users | user_id | å¤‰æ›´è€…ã®å­˜åœ¨ä¿è¨¼ |

#### ğŸ“– **å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®åŠ¹æœã¨ä¾‹**

```sql
-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚‹è‡ªå‹•çš„ãªãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

-- 1. å­˜åœ¨ã—ãªã„åŒ»ç™‚æ©Ÿé–¢ã¸ã®å‚ç…§ã¯è‡ªå‹•çš„ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
INSERT INTO addresses (hospital_id, full_address) 
VALUES ('INVALID_ID', 'å­˜åœ¨ã—ãªã„ç—…é™¢ã®ä½æ‰€');
-- â†’ ã‚¨ãƒ©ãƒ¼: Cannot add or update a child row: a foreign key constraint fails

-- 2. å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã§ããªã„
DELETE FROM hospitals WHERE hospital_id = 'H001';
-- â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆã‚‚ã—addressesã‚„contact_detailsã§H001ãŒå‚ç…§ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
-- â†’ Error: Cannot delete or update a parent row: a foreign key constraint fails

-- 3. åˆ¶ç´„ãƒã‚§ãƒƒã‚¯ã®ä¸€æ™‚çš„ç„¡åŠ¹åŒ–ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ã¿ï¼‰
SET FOREIGN_KEY_CHECKS = 0;
-- å±é™ºãªæ“ä½œã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œãªã©ï¼‰
SET FOREIGN_KEY_CHECKS = 1;

-- 4. åˆ¶ç´„é•åãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªæ–¹æ³•
SELECT h.hospital_id 
FROM hospitals h
LEFT JOIN addresses a ON h.hospital_id = a.hospital_id
WHERE a.hospital_id IS NULL;  -- ä½æ‰€ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„åŒ»ç™‚æ©Ÿé–¢
```

---

### ENUMå‹å®šç¾©å®Œå…¨ãƒªã‚¹ãƒˆ

#### ğŸ“ **å³æ ¼ãªå€¤åˆ¶é™ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ16å€‹ã®ENUMå®šç¾©ï¼‰**

| # | ãƒ†ãƒ¼ãƒ–ãƒ«å | ã‚«ãƒ©ãƒ å | è¨±å¯å€¤ | ç”¨é€”ãƒ»èª¬æ˜ |
|---|-----------|---------|--------|-----------|
| **1** | hospitals | status | `'active'`, `'closed'` | åŒ»ç™‚æ©Ÿé–¢ã®é‹å–¶çŠ¶æ³ |
| **2** | hospital_staffs | role_type | `'chairman'`, `'director'` | å½¹è·ç¨®åˆ¥ï¼ˆç†äº‹é•·ãƒ»ç—…é™¢é•·ï¼‰ |
| **3** | consultation_hours | day_of_week | `'monday'`, `'tuesday'`, `'wednesday'`, `'thursday'`, `'friday'`, `'saturday'`, `'sunday'`, `'holiday'` | è¨ºç™‚æ›œæ—¥ |
| **4** | consultation_hours | period | `'AM'`, `'PM'`, `'AM_PM'` | è¨ºç™‚æ™‚é–“å¸¯ |
| **5** | introductions | intro_type | `'intro'`, `'invers_intro'` | ç´¹ä»‹ãƒ»é€†ç´¹ä»‹ã®åŒºåˆ¥ |
| **6** | users | role | `'admin'`, `'editor'`, `'viewer'` | ã‚·ã‚¹ãƒ†ãƒ æ¨©é™ãƒ¬ãƒ™ãƒ« |
| **7** | unified_logs | log_type | `'audit'`, `'login_attempt'`, `'access'`, `'security'` | ãƒ­ã‚°ã®ç¨®åˆ¥åˆ†é¡ |
| **8** | unified_logs | action_type | `'INSERT'`, `'UPDATE'`, `'DELETE'` | ãƒ‡ãƒ¼ã‚¿æ“ä½œç¨®åˆ¥ |
| **9** | unified_logs | access_type | `'login'`, `'logout'`, `'page_access'`, `'api_access'`, `'download'`, `'upload'`, `'error'` | ã‚¢ã‚¯ã‚»ã‚¹ç¨®åˆ¥ |
| **10** | unified_logs | http_method | `'GET'`, `'POST'`, `'PUT'`, `'DELETE'`, `'PATCH'` | HTTPãƒ¡ã‚½ãƒƒãƒ‰ |
| **11** | unified_logs | event_type | `'login_success'`, `'login_failure'`, `'password_change'`, `'account_lock'`, `'permission_denied'`, `'suspicious_access'`, `'data_export'`, `'admin_access'` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ |
| **12** | unified_logs | severity | `'low'`, `'medium'`, `'high'`, `'critical'` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ« |
| **13** | inquires | priority | `'general'`, `'urgent'` | å•ã„åˆã‚ã›å„ªå…ˆåº¦ |
| **14** | inquires | status | `'open'`, `'in_progress'`, `'resolved'`, `'closed'` | å•ã„åˆã‚ã›å¯¾å¿œçŠ¶æ³ |
| **15** | message | status | `'open'`, `'in_progress'`, `'completed'`, `'rejected'` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è¦æœ›ã®å¯¾å¿œçŠ¶æ³ |
| **16** | message | priority | `'low'`, `'normal'`, `'urgent'` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å„ªå…ˆåº¦ |
| **17** | system_status | system_mode | `'normal'`, `'maintenance'`, `'read_only'` | ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œãƒ¢ãƒ¼ãƒ‰ |

#### ğŸ“– **ENUMå‹ã®åŠ¹æœã¨ä½¿ç”¨ä¾‹**

```sql
-- ENUMå‹ã«ã‚ˆã‚‹å³æ ¼ãªå€¤åˆ¶é™

-- 1. æ­£ã—ã„å€¤ã®ã¿æŒ¿å…¥å¯èƒ½
INSERT INTO hospitals (hospital_id, hospital_name, status) 
VALUES ('H001', 'ãƒ†ã‚¹ãƒˆç—…é™¢', 'active');  -- âœ… æˆåŠŸ

INSERT INTO hospitals (hospital_id, hospital_name, status) 
VALUES ('H002', 'ãƒ†ã‚¹ãƒˆç—…é™¢2', 'invalid_status');  
-- âŒ ã‚¨ãƒ©ãƒ¼: Data truncated for column 'status'

-- 2. ENUMå€¤ã§ã®åŠ¹ç‡çš„ãªæ¤œç´¢
SELECT COUNT(*) FROM hospitals WHERE status = 'active';
-- â†’ ENUMã¯å†…éƒ¨çš„ã«æ•°å€¤ã¨ã—ã¦æ ¼ç´ã•ã‚Œã‚‹ãŸã‚é«˜é€Ÿ

-- 3. çµ±è¨ˆå‡¦ç†ã§ã®æ´»ç”¨
SELECT 
    status,
    COUNT(*) as count
FROM hospitals 
GROUP BY status;
-- çµæœä¾‹:
-- active    | 150
-- closed    | 25

-- 4. æ¡ä»¶åˆ†å²ã§ã®ä½¿ç”¨
SELECT 
    hospital_name,
    CASE status 
        WHEN 'active' THEN 'ç¨¼åƒä¸­'
        WHEN 'closed' THEN 'ä¼‘æ­¢ä¸­'
        ELSE 'ä¸æ˜'
    END as status_jp
FROM hospitals;
```

#### âš ï¸ **ENUMå‹ä½¿ç”¨æ™‚ã®æ³¨æ„ç‚¹**

- **å€¤ã®è¿½åŠ **: æ–°ã—ã„å€¤ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ALTER TABLEãŒå¿…è¦
- **é †åºæ€§**: ENUMå€¤ã«ã¯å†…éƒ¨çš„ãªé †åºãŒã‚ã‚Šã€ã‚½ãƒ¼ãƒˆçµæœã«å½±éŸ¿
- **å›½éš›åŒ–**: è‹±èªå€¤ã®ãŸã‚ã€æ—¥æœ¬èªè¡¨ç¤ºæ™‚ã¯å¤‰æ›ãŒå¿…è¦
- **ç§»æ¤æ€§**: MySQLå›ºæœ‰ã®æ©Ÿèƒ½ã®ãŸã‚ã€ä»–DBMSã§ã¯å‹•ä½œã—ãªã„

---

### ğŸ¥ åŒ»ç™‚æ©Ÿé–¢åŸºæœ¬æƒ…å ±ç³» (6ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `hospital_types` | ç—…é™¢åŒºåˆ†ãƒã‚¹ã‚¿ | type_id |
| `hospitals` | åŒ»ç™‚æ©Ÿé–¢åŸºæœ¬æƒ…å ± | hospital_id |
| `areas` | åœ°åŸŸæƒ…å ±ãƒã‚¹ã‚¿ | area_id |
| `addresses` | åŒ»ç™‚æ©Ÿé–¢ä½æ‰€ | address_id |
| `contact_details` | é€£çµ¡å…ˆæƒ…å ± | contact_id |
| `hospital_staffs` | ç—…é™¢ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ± | staff_id |

### ğŸ“‹ è¨ºç™‚ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ç³» (8ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `consultation_hours` | è¨ºç™‚æ™‚é–“ | è¤‡åˆã‚­ãƒ¼ |
| `medical_departments` | è¨ºç™‚ç§‘ãƒã‚¹ã‚¿ | department_id |
| `hospital_departments` | ç—…é™¢-è¨ºç™‚ç§‘é–¢é€£ | è¤‡åˆã‚­ãƒ¼ |
| `medical_services` | è¨ºç™‚å†…å®¹ãƒã‚¹ã‚¿ | è¤‡åˆã‚­ãƒ¼ |
| `hospital_services` | ç—…é™¢-è¨ºç™‚å†…å®¹é–¢é€£ | è¤‡åˆã‚­ãƒ¼ |
| `ward_types` | ç—…æ£Ÿç¨®é¡ãƒã‚¹ã‚¿ | ward_id |
| `hospitals_ward_types` | ç—…é™¢-ç—…æ£Ÿé–¢é€£ | è¤‡åˆã‚­ãƒ¼ |
| `clinical_pathways` | é€£æºãƒ‘ã‚¹ãƒã‚¹ã‚¿ | clinical_pathway_id |

### ğŸ‘¥ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ç³» (4ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `users` | ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ | user_id |
| `kawasaki_university_facilities` | å·å´å­¦åœ’æ–½è¨­ãƒã‚¹ã‚¿ | facility_id |
| `kawasaki_university_departments` | å·å´å­¦åœ’éƒ¨ç½²ãƒã‚¹ã‚¿ | department_id |
| `unified_logs` | çµ±åˆãƒ­ã‚° | log_id |

### ğŸ“Š çµ±åˆãƒ‡ãƒ¼ã‚¿ç³» (5ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `introductions` | ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿ | è¤‡åˆã‚­ãƒ¼ |
| `training` | å…¼æ¥­ãƒ»ç ”ä¿®ãƒ‡ãƒ¼ã‚¿ | è¤‡åˆã‚­ãƒ¼ |
| `positions` | è·åãƒã‚¹ã‚¿ | position_id |
| `contacts` | ã‚³ãƒ³ã‚¿ã‚¯ãƒˆå±¥æ­´ | è¤‡åˆã‚­ãƒ¼ |
| `inquires` | å•ã„åˆã‚ã›ç®¡ç† | inquire_id |

### âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ é‹å–¶ç³» (5ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `maintenance` | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€šçŸ¥ | maintenance_id |
| `maintenance_start` | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Ÿè¡Œä¸­é€šçŸ¥ | id |
| `message` | ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°å±¥æ­´ãƒ»è¦æœ› | message_id |
| `system_status` | ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç®¡ç† | status_id |
| `system_versions` | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† | version_id |

### ğŸ”— å¤–éƒ¨é€£æºç³» (2ãƒ†ãƒ¼ãƒ–ãƒ«)
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ä¸»ã‚­ãƒ¼ |
|-----------|------|--------|
| `carna_connects` | ã‚«ãƒ«ãƒŠã‚³ãƒã‚¯ãƒˆæƒ…å ± | hospital_id |
| `clinical_pathway_hospitals` | é€£æºãƒ‘ã‚¹-ç—…é™¢é–¢é€£ | è¤‡åˆã‚­ãƒ¼ |

---

## ğŸ“š åˆå­¦è€…å‘ã‘æŠ€è¡“è§£èª¬

### ğŸ” **ã“ã‚Œã‚‰ã®æŠ€è¡“ãŒå¿…è¦ãªç†ç”±**

#### **1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆIndexï¼‰**
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢é€Ÿåº¦ã‚’åŠ‡çš„ã«å‘ä¸Šã•ã›ã‚‹
- **ä¾‹**: 1ä¸‡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®ç—…é™¢ã‚’æ¢ã™å ´åˆ
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—ï¼š1ä¸‡ä»¶å…¨ã¦ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆé…ã„ï¼‰
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚ã‚Šï¼šæ•°å›ã®æ¯”è¼ƒã§ç™ºè¦‹ï¼ˆé€Ÿã„ï¼‰

#### **2. ãƒˆãƒªã‚¬ãƒ¼ï¼ˆTriggerï¼‰**  
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•çš„ã«é–¢é€£å‡¦ç†ã‚’å®Ÿè¡Œ
- **ä¾‹**: ç—…é™¢æƒ…å ±ã‚’å¤‰æ›´ã—ãŸç¬é–“ã«ã€å¤‰æ›´å±¥æ­´ãŒè‡ªå‹•çš„ã«è¨˜éŒ²ã•ã‚Œã‚‹
- **åˆ©ç‚¹**: äººé–“ãŒå¿˜ã‚Œã‚‹ã“ã¨ãªãç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹

#### **3. ãƒ“ãƒ¥ãƒ¼ï¼ˆViewï¼‰**
**ç›®çš„**: è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿çµåˆã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
- **ä¾‹**: 5ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã™ã‚‹è¤‡é›‘ãªå‡¦ç†ã‚’1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚ˆã†ã«ä½¿ç”¨
- **åˆ©ç‚¹**: åŒã˜è¤‡é›‘ãªå‡¦ç†ã‚’ä½•åº¦ã‚‚æ›¸ãå¿…è¦ãŒãªã„

#### **4. ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ï¼ˆStored Procedureï¼‰**
**ç›®çš„**: ã‚ˆãä½¿ã†å‡¦ç†ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã«ä¿å­˜ã—ã¦å†åˆ©ç”¨
- **ä¾‹**: å•ã„åˆã‚ã›ã®çŠ¶æ…‹æ›´æ–°ã‚„å±¥æ­´è¨˜éŒ²ã‚’ä¸€æ‹¬å®Ÿè¡Œ
- **åˆ©ç‚¹**: å‡¦ç†ã®ä¸€è²«æ€§ã¨å®Ÿè¡Œé€Ÿåº¦ã®å‘ä¸Š

#### **5. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ï¼ˆForeign Keyï¼‰**
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’è‡ªå‹•çš„ã«ä¿è¨¼
- **ä¾‹**: å­˜åœ¨ã—ãªã„ç—…é™¢IDã§ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨è‡ªå‹•çš„ã«ã‚¨ãƒ©ãƒ¼
- **åˆ©ç‚¹**: ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆã‚’æ ¹æœ¬çš„ã«é˜²æ­¢

#### **6. ENUMå‹**
**ç›®çš„**: è¨±å¯ã•ã‚ŒãŸå€¤ä»¥å¤–ã®å…¥åŠ›ã‚’é˜²æ­¢
- **ä¾‹**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«'active'ã¨'closed'ä»¥å¤–ã¯å…¥åŠ›ä¸å¯
- **åˆ©ç‚¹**: ãƒ‡ãƒ¼ã‚¿å“è³ªã®å‘ä¸Šã¨ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ã®é˜²æ­¢

### ğŸ“ **å­¦ç¿’ã®é€²ã‚æ–¹**

1. **åŸºç¤çŸ¥è­˜**: ã¾ãšSQLã®åŸºæœ¬ï¼ˆSELECTã€INSERTã€UPDATEã€DELETEï¼‰ã‚’ç¿’å¾—
2. **å®Ÿè·µ**: å®Ÿéš›ã«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã®å‹•ãã‚’ç¢ºèª
3. **å¿œç”¨**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚„ãƒ“ãƒ¥ãƒ¼ã®åŠ¹æœã‚’ä½“æ„Ÿ
4. **ä¸Šç´š**: ãƒˆãƒªã‚¬ãƒ¼ã‚„ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®ä½œæˆãƒ»ä¿®æ­£

---

## ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆä¸€è¦§

### ğŸ¥ hospitalsï¼ˆåŒ»ç™‚æ©Ÿé–¢åŸºæœ¬æƒ…å ±ï¼‰

**ç”¨é€”**: ãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹åŒ»ç™‚æ©Ÿé–¢æƒ…å ±ã‚’ç®¡ç†

```sql
-- åŸºæœ¬çš„ãªåŒ»ç™‚æ©Ÿé–¢æƒ…å ±å–å¾—
SELECT h.hospital_id, h.hospital_name, h.status, h.bed_count,
       ht.type_name as hospital_type
FROM hospitals h
LEFT JOIN hospital_types ht ON h.hospital_type_id = ht.type_id
WHERE h.status = 'active';

-- ç†å­¦ç™‚æ³•å£«åœ¨ç±ç—…é™¢ã®æ¤œç´¢
SELECT hospital_id, hospital_name 
FROM hospitals 
WHERE has_pt = true AND status = 'active';
```

**é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `hospital_id`: åŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰ï¼ˆ10æ–‡å­—ï¼‰
- `hospital_name`: åŒ»ç™‚æ©Ÿé–¢å
- `status`: é‹å–¶çŠ¶æ³ï¼ˆactive/closedï¼‰
- `has_pt/has_ot/has_st`: å°‚é–€ç™‚æ³•å£«åœ¨ç±ãƒ•ãƒ©ã‚°

### ğŸ“‹ unified_logsï¼ˆçµ±åˆãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ï¼‰

**ç”¨é€”**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ­ã‚°ã‚’ä¸€å…ƒç®¡ç†

```sql
-- ç›£æŸ»ãƒ­ã‚°ã®ç¢ºèª
SELECT table_name, action_type, COUNT(*) as count
FROM unified_logs 
WHERE log_type = 'audit' 
  AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY table_name, action_type;

-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¢ºèª
SELECT event_type, severity, description, ip_address, created_at
FROM unified_logs 
WHERE log_type = 'security' 
  AND severity IN ('high', 'critical')
ORDER BY created_at DESC;

-- ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
SELECT access_type, page_name, page_url, created_at
FROM unified_logs 
WHERE log_type = 'access' 
  AND user_id = 'USER001'
  AND created_at >= CURDATE()
ORDER BY created_at DESC;
```

**ãƒ­ã‚°ç¨®åˆ¥**:
- `audit`: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®ç›£æŸ»
- `access`: ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
- `security`: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ
- `login_attempt`: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œè¨˜éŒ²

### ğŸ”§ maintenanceï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç®¡ç†ï¼‰

**ç”¨é€”**: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®äºˆå®šãƒ»å®Ÿè¡Œç®¡ç†

```sql
-- ä»Šå¾Œã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®š
SELECT title, comment, date, start_time, end_time
FROM maintenance 
WHERE date >= CURDATE() AND view = true
ORDER BY date ASC, start_time ASC;

-- ç¾åœ¨å®Ÿè¡Œä¸­ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
SELECT m.title, ms.description, ms.implementation_details
FROM maintenance m
JOIN maintenance_start ms ON m.maintenance_id = ms.maintenance_id
WHERE m.date = CURDATE() 
  AND CURTIME() BETWEEN COALESCE(m.start_time, '00:00:00') 
  AND COALESCE(m.end_time, '23:59:59')
  AND ms.view = true;
```

### ğŸ’¬ inquiresï¼ˆå•ã„åˆã‚ã›ç®¡ç†ï¼‰

**ç”¨é€”**: ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å•ã„åˆã‚ã›ãƒ»è¦æœ›ã‚’ç®¡ç†

```sql
-- æœªå¯¾å¿œã®ç·Šæ€¥å•ã„åˆã‚ã›
SELECT inquire_id, description, created_at, 
       TIMESTAMPDIFF(HOUR, created_at, NOW()) as hours_elapsed
FROM inquires 
WHERE status = 'open' 
  AND priority = 'urgent'
ORDER BY created_at ASC;

-- å•ã„åˆã‚ã›ã®çµ±è¨ˆæƒ…å ±
SELECT 
    status,
    COUNT(*) as count,
    AVG(TIMESTAMPDIFF(HOUR, created_at, COALESCE(resolved_at, NOW()))) as avg_response_hours
FROM inquires 
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY status;
```

### ğŸ“Š introductionsï¼ˆç´¹ä»‹ãƒ‡ãƒ¼ã‚¿ï¼‰

**ç”¨é€”**: åŒ»ç™‚æ©Ÿé–¢é–“ã®ç´¹ä»‹ãƒ»é€†ç´¹ä»‹ãƒ‡ãƒ¼ã‚¿

```sql
-- æœˆåˆ¥ç´¹ä»‹ä»¶æ•°ã®é›†è¨ˆ
SELECT 
    h.hospital_name,
    YEAR(i.date) as year,
    MONTH(i.date) as month,
    i.intro_type,
    SUM(i.intro_count) as total_count
FROM introductions i
JOIN hospitals h ON i.hospital_id = h.hospital_id
WHERE i.year = YEAR(CURDATE())
GROUP BY h.hospital_name, YEAR(i.date), MONTH(i.date), i.intro_type
ORDER BY year, month, h.hospital_name;

-- è¨ºç™‚ç§‘åˆ¥ç´¹ä»‹å®Ÿç¸¾
SELECT 
    department_name,
    intro_type,
    SUM(intro_count) as total_introductions
FROM introductions
WHERE year = YEAR(CURDATE())
GROUP BY department_name, intro_type
ORDER BY total_introductions DESC;
```

---

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### ä¸»è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- æ¤œç´¢æ€§èƒ½å‘ä¸Šã®ãŸã‚ã®ä¸»è¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_hospitals_status ON hospitals(status);
CREATE INDEX idx_unified_logs_type_created ON unified_logs(log_type, created_at);
CREATE INDEX idx_unified_logs_user_created ON unified_logs(user_id, created_at);
CREATE INDEX idx_maintenance_date_time ON maintenance(date, start_time, end_time);
CREATE INDEX idx_inquires_status_priority ON inquires(status, priority);
CREATE INDEX idx_introductions_hospital_year ON introductions(hospital_id, year);
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ç¢ºèª

```sql
-- ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
EXPLAIN SELECT * FROM hospitals WHERE status = 'active';

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨çŠ¶æ³ã®ç¢ºèª
SHOW INDEX FROM hospitals;
```

---

## ãƒˆãƒªã‚¬ãƒ¼ãƒ»ç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ 

### è‡ªå‹•ç›£æŸ»ãƒ­ã‚°

å…¨ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯è‡ªå‹•ç›£æŸ»ãƒˆãƒªã‚¬ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼š

```sql
-- ä¾‹ï¼šhospitalsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã‚’ç›£æŸ»
-- ãƒˆãƒªã‚¬ãƒ¼ãŒè‡ªå‹•çš„ã«unified_logsã«è¨˜éŒ²

-- ç›£æŸ»ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•
SELECT 
    table_name,
    record_id,
    action_type,
    JSON_EXTRACT(old_values, '$.hospital_name') as old_name,
    JSON_EXTRACT(new_values, '$.hospital_name') as new_name,
    created_at
FROM unified_logs 
WHERE log_type = 'audit' 
  AND table_name = 'hospitals'
ORDER BY created_at DESC;
```

### ãƒˆãƒªã‚¬ãƒ¼ä¸€è¦§

å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ãƒˆãƒªã‚¬ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼š
- `{table_name}_insert_audit`: INSERTæ™‚ã®ç›£æŸ»
- `{table_name}_update_audit`: UPDATEæ™‚ã®ç›£æŸ»  
- `{table_name}_delete_audit`: DELETEæ™‚ã®ç›£æŸ»

---

## ãƒ“ãƒ¥ãƒ¼ä¸€è¦§

### ğŸ“Š é‹ç”¨ç›£è¦–ãƒ“ãƒ¥ãƒ¼

#### `audit_summary`
```sql
-- ç›£æŸ»ãƒ­ã‚°ã®æ¦‚è¦
SELECT * FROM audit_summary;
```

#### `system_status_current`
```sql
-- ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
SELECT * FROM system_status_current;
```

#### `maintenance_schedule`
```sql
-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
SELECT * FROM maintenance_schedule WHERE status IN ('äºˆå®š', 'æœ¬æ—¥äºˆå®š');
```

### ğŸ“ˆ çµ±è¨ˆãƒ»åˆ†æãƒ“ãƒ¥ãƒ¼

#### `inquire_management`
```sql
-- å•ã„åˆã‚ã›ç®¡ç†çŠ¶æ³
SELECT * FROM inquire_management WHERE status = 'open';
```

#### `system_usage_stats`
```sql
-- ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çµ±è¨ˆï¼ˆéå»30æ—¥ï¼‰
SELECT * FROM system_usage_stats ORDER BY usage_date DESC;
```

#### `version_statistics`
```sql
-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥çµ±è¨ˆ
SELECT * FROM version_statistics ORDER BY release_date DESC;
```

---

## ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ»é–¢æ•°

### ğŸ”§ ä¾¿åˆ©ãªé–¢æ•°

#### `get_current_version()`
```sql
-- ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
SELECT get_current_version() as current_version;
```

### ğŸ“‹ ç®¡ç†ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£

#### `switch_current_version(version_id)`
```sql
-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å®‰å…¨ãªåˆ‡ã‚Šæ›¿ãˆ
CALL switch_current_version(5);
```

#### `escalate_urgent_inquiries()`
```sql
-- ç·Šæ€¥å•ã„åˆã‚ã›ã®è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
CALL escalate_urgent_inquiries();
```

#### `update_inquire_status()`
```sql
-- å•ã„åˆã‚ã›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¸€æ‹¬æ›´æ–°
CALL update_inquire_status(123, 'resolved', 'è§£æ±ºæ¸ˆã¿', 'ADMIN001');
```

---

## ğŸ”§ é«˜åº¦æŠ€è¡“ã®å®Ÿè·µçš„æ´»ç”¨ä¾‹

### ğŸ’¡ **å®Ÿéš›ã®é‹ç”¨ã‚·ãƒ¼ãƒ³ã§ã®ä½¿ã„æ–¹**

#### **ã‚·ãƒ¼ãƒ³1: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ**
```sql
-- è¤‡é›‘ãªé›†è¨ˆã‚‚ãƒ“ãƒ¥ãƒ¼ã‚’ä½¿ãˆã°ç°¡å˜
SELECT * FROM inquire_statistics 
WHERE inquiry_date >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH);
-- â†’ 5è¡Œã§æœˆæ¬¡å•ã„åˆã‚ã›ãƒ¬ãƒãƒ¼ãƒˆå®Œæˆ
```

#### **ã‚·ãƒ¼ãƒ³2: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
```sql
-- ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§è¤‡é›‘ãªå‡¦ç†ã‚’ä¸€æ‹¬å®Ÿè¡Œ
CALL switch_current_version(6);
-- â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆã«å¿…è¦ãªè¤‡æ•°ã®å‡¦ç†ã‚’å®‰å…¨ã«å®Ÿè¡Œ
```

#### **ã‚·ãƒ¼ãƒ³3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»**
```sql
-- ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•è¨˜éŒ²ã•ã‚ŒãŸç›£æŸ»è¨¼è·¡ã®ç¢ºèª
SELECT * FROM audit_summary 
WHERE table_name = 'hospitals' AND action_type = 'UPDATE';
-- â†’ ç—…é™¢æƒ…å ±ã®å¤‰æ›´å±¥æ­´ã‚’ç¬æ™‚ã«å–å¾—
```

#### **ã‚·ãƒ¼ãƒ³4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´**
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŠ¹æœç¢ºèª
EXPLAIN SELECT * FROM inquires WHERE status = 'urgent';
-- â†’ key: idx_inquires_status ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æœ€é©åŒ–æˆåŠŸ
```

### âš¡ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒä¾‹**

```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—ã®å ´åˆï¼ˆé…ã„ï¼‰
SELECT * FROM unified_logs WHERE created_at >= '2024-01-01';
-- å®Ÿè¡Œæ™‚é–“: 2.5ç§’ï¼ˆ100ä¸‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼‰

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚ã‚Šã®å ´åˆï¼ˆé€Ÿã„ï¼‰  
SELECT * FROM unified_logs WHERE created_at >= '2024-01-01';
-- å®Ÿè¡Œæ™‚é–“: 0.05ç§’ï¼ˆidx_unified_logs_created_atã‚’ä½¿ç”¨ï¼‰
```

### ğŸ›¡ï¸ **ãƒ‡ãƒ¼ã‚¿ä¿è­·ã®å®Ÿä¾‹**

```sql
-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«ã‚ˆã‚‹ä¿è­·ä¾‹
INSERT INTO inquires (user_id, description) 
VALUES ('INVALID_USER', 'ãƒ†ã‚¹ãƒˆå•ã„åˆã‚ã›');
-- â†’ ã‚¨ãƒ©ãƒ¼: å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãŸã‚æŒ¿å…¥ä¸å¯
-- â†’ ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒè‡ªå‹•çš„ã«ä¿è­·ã•ã‚Œã‚‹
```

---

## ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªä¾‹

### ğŸ” åŸºæœ¬çš„ãªæ¤œç´¢ã‚¯ã‚¨ãƒª

#### 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåŒ»ç™‚æ©Ÿé–¢ã®ä¸€è¦§
```sql
SELECT 
    h.hospital_id,
    h.hospital_name,
    ht.type_name,
    h.bed_count,
    CASE 
        WHEN h.has_pt THEN 'ç†å­¦ç™‚æ³•å£«'
        WHEN h.has_ot THEN 'ä½œæ¥­ç™‚æ³•å£«'  
        WHEN h.has_st THEN 'è¨€èªè´è¦šå£«'
        ELSE 'ãªã—'
    END as therapy_staff
FROM hospitals h
LEFT JOIN hospital_types ht ON h.hospital_type_id = ht.type_id
WHERE h.status = 'active'
ORDER BY h.hospital_name;
```

#### 2. åœ°åŸŸåˆ¥åŒ»ç™‚æ©Ÿé–¢æ¤œç´¢
```sql
SELECT 
    h.hospital_name,
    a.prefecture,
    a.city,
    a.town,
    addr.full_address
FROM hospitals h
JOIN addresses addr ON h.hospital_id = addr.hospital_id
JOIN areas a ON addr.area_id = a.area_id
WHERE a.prefecture = 'å²¡å±±çœŒ' 
  AND h.status = 'active'
ORDER BY a.city, h.hospital_name;
```

#### 3. è¨ºç™‚ç§‘åˆ¥åŒ»ç™‚æ©Ÿé–¢æ¤œç´¢
```sql
SELECT DISTINCT
    h.hospital_name,
    md.department_name,
    md.category
FROM hospitals h
JOIN hospital_departments hd ON h.hospital_id = hd.hospital_id
JOIN medical_departments md ON hd.department_id = md.department_id
WHERE md.department_name LIKE '%å†…ç§‘%'
  AND h.status = 'active'
  AND md.is_active = true
ORDER BY h.hospital_name;
```

### ğŸ“Š çµ±è¨ˆãƒ»åˆ†æã‚¯ã‚¨ãƒª

#### 4. æœˆåˆ¥ç´¹ä»‹å®Ÿç¸¾ã‚µãƒãƒªãƒ¼
```sql
SELECT 
    DATE_FORMAT(i.date, '%Y-%m') as month,
    COUNT(DISTINCT i.hospital_id) as hospital_count,
    SUM(CASE WHEN i.intro_type = 'intro' THEN i.intro_count ELSE 0 END) as introductions,
    SUM(CASE WHEN i.intro_type = 'invers_intro' THEN i.intro_count ELSE 0 END) as reverse_introductions
FROM introductions i
WHERE i.year = YEAR(CURDATE())
GROUP BY DATE_FORMAT(i.date, '%Y-%m')
ORDER BY month;
```

#### 5. ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨çŠ¶æ³åˆ†æ
```sql
SELECT 
    DATE(ul.created_at) as date,
    COUNT(DISTINCT ul.user_id) as unique_users,
    COUNT(CASE WHEN ul.access_type = 'login' THEN 1 END) as logins,
    COUNT(CASE WHEN ul.log_type = 'security' AND ul.severity = 'high' THEN 1 END) as security_alerts
FROM unified_logs ul
WHERE ul.created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY DATE(ul.created_at)
ORDER BY date DESC;
```

### ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»é‹ç”¨ã‚¯ã‚¨ãƒª

#### 6. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç¢ºèª
```sql
-- ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
SELECT 
    system_mode,
    status_message,
    changed_by,
    updated_at
FROM system_status 
ORDER BY updated_at DESC 
LIMIT 1;

-- ç¾åœ¨ç¨¼åƒä¸­ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
SELECT 
    version_number,
    release_date,
    release_notes
FROM system_versions 
WHERE is_current = true;
```

#### 7. æœªå¯¾å¿œå•ã„åˆã‚ã›ã®ç¢ºèª
```sql
SELECT 
    i.inquire_id,
    i.priority,
    i.description,
    u.user_name as inquirer,
    TIMESTAMPDIFF(HOUR, i.created_at, NOW()) as hours_elapsed
FROM inquires i
JOIN users u ON i.user_id = u.user_id
WHERE i.status IN ('open', 'in_progress')
ORDER BY 
    CASE i.priority WHEN 'urgent' THEN 1 ELSE 2 END,
    i.created_at ASC;
```

---

## ï¿½ **å®Ÿè·µçš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ**

### **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœã®å®Ÿæ¸¬ä¾‹**

#### **æ¤œç´¢é€Ÿåº¦æ¯”è¼ƒï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿10ä¸‡ä»¶ï¼‰**

```sql
-- âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—ã®å ´åˆ
SELECT * FROM unified_logs WHERE user_id = 'USER001';
-- å®Ÿè¡Œæ™‚é–“: 0.12ç§’ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
-- rows examined: 100,000

-- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚ã‚Šã®å ´åˆ  
CREATE INDEX idx_unified_logs_user_id ON unified_logs(user_id);
SELECT * FROM unified_logs WHERE user_id = 'USER001';
-- å®Ÿè¡Œæ™‚é–“: 0.001ç§’ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¤œç´¢ï¼‰
-- rows examined: 15
-- **120å€ã®é«˜é€ŸåŒ–ï¼**
```

#### **è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å¨åŠ›**

```sql
-- å˜ä¸€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å ´åˆ
CREATE INDEX idx_created_at ON unified_logs(created_at);
SELECT * FROM unified_logs 
WHERE created_at >= '2024-01-01' AND user_id = 'USER001';
-- å®Ÿè¡Œæ™‚é–“: 0.08ç§’

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å ´åˆ
CREATE INDEX idx_composite ON unified_logs(user_id, created_at);
SELECT * FROM unified_logs 
WHERE created_at >= '2024-01-01' AND user_id = 'USER001';
-- å®Ÿè¡Œæ™‚é–“: 0.002ç§’
-- **40å€ã®é«˜é€ŸåŒ–ï¼**
```

### **ãƒˆãƒªã‚¬ãƒ¼ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰åˆ†æ**

#### **ãƒ‡ãƒ¼ã‚¿æ›´æ–°é€Ÿåº¦ã¸ã®å½±éŸ¿**

```sql
-- ãƒˆãƒªã‚¬ãƒ¼ãªã—ã®å ´åˆ
INSERT INTO hospitals (hospital_id, hospital_name) 
VALUES ('H999', 'ãƒ†ã‚¹ãƒˆç—…é™¢');
-- å®Ÿè¡Œæ™‚é–“: 0.001ç§’

-- ãƒˆãƒªã‚¬ãƒ¼ã‚ã‚Šã®å ´åˆï¼ˆç›£æŸ»ãƒ­ã‚°1å€‹ï¼‰
-- å®Ÿè¡Œæ™‚é–“: 0.003ç§’ï¼ˆ3å€é…ããªã‚‹ï¼‰

-- ãƒˆãƒªã‚¬ãƒ¼è¤‡æ•°ã®å ´åˆï¼ˆç›£æŸ»ãƒ­ã‚° + é€šçŸ¥ + é›†è¨ˆæ›´æ–°ï¼‰
-- å®Ÿè¡Œæ™‚é–“: 0.015ç§’ï¼ˆ15å€é…ããªã‚‹ï¼‰
```

**ğŸ” ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã®ã‚³ãƒ„**
```sql
-- ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
EXPLAIN FORMAT=JSON 
SELECT h.hospital_name, a.prefecture 
FROM hospitals h 
JOIN addresses a ON h.hospital_id = a.hospital_id 
WHERE a.prefecture = 'æ±äº¬éƒ½';

-- å®Ÿè¡Œæ™‚é–“ã®æ­£ç¢ºãªæ¸¬å®š
SET profiling = 1;
SELECT COUNT(*) FROM unified_logs WHERE action_type = 'UPDATE';
SHOW PROFILES;
```

### **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã®åŠ¹ç‡åŒ–**

#### **ãƒ‡ãƒ¼ã‚¿å‹é¸æŠã®å½±éŸ¿**

```sql
-- âŒ éåŠ¹ç‡ãªè¨­è¨ˆ
CREATE TABLE bad_example (
    id VARCHAR(255),           -- 255æ–‡å­—ã‚‚å¿…è¦ï¼Ÿ
    status VARCHAR(100),       -- ENUMã§ååˆ†
    created_at DATETIME(6)     -- ãƒã‚¤ã‚¯ãƒ­ç§’ã¾ã§å¿…è¦ï¼Ÿ
);
-- 1ãƒ¬ã‚³ãƒ¼ãƒ‰: ç´„400ãƒã‚¤ãƒˆ

-- âœ… åŠ¹ç‡çš„ãªè¨­è¨ˆ
CREATE TABLE good_example (
    id VARCHAR(20),            -- å®Ÿéš›ã®æœ€å¤§é•·ã«åˆã‚ã›ã‚‹
    status ENUM('active', 'inactive', 'pending'),  -- å›ºå®šå€¤
    created_at TIMESTAMP      -- ç§’å˜ä½ã§ååˆ†
);
-- 1ãƒ¬ã‚³ãƒ¼ãƒ‰: ç´„30ãƒã‚¤ãƒˆ
-- **90%ä»¥ä¸Šã®å®¹é‡å‰Šæ¸›ï¼**
```

### **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–**

#### **æ¥ç¶šãƒ—ãƒ¼ãƒ«ã¨ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**

```sql
-- MyISAM vs InnoDB ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¯”è¼ƒ
-- MyISAM: ãƒ†ãƒ¼ãƒ–ãƒ«1ã¤ã‚ãŸã‚Š ç´„8KBï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã¿ãƒ¡ãƒ¢ãƒªï¼‰
-- InnoDB:  ãƒ†ãƒ¼ãƒ–ãƒ«1ã¤ã‚ãŸã‚Š ç´„16MBï¼ˆãƒ‡ãƒ¼ã‚¿ã‚‚ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

-- InnoDBãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã®ç¢ºèª
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
-- æ¨å¥¨å€¤: ç‰©ç†ãƒ¡ãƒ¢ãƒªã®70-80%

-- ç¾åœ¨ã®ä½¿ç”¨çŠ¶æ³ç¢ºèª
SELECT 
    ROUND(data_length/1024/1024,1) AS data_mb,
    ROUND(index_length/1024/1024,1) AS index_mb,
    ROUND((data_length + index_length)/1024/1024,1) AS total_mb
FROM information_schema.tables 
WHERE table_schema = 'newhptldb';
```

---

## ï¿½ğŸ”§ é«˜åº¦æŠ€è¡“ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### â— **ã‚ˆãã‚ã‚‹æŠ€è¡“çš„å•é¡Œã¨è§£æ±ºç­–**

#### **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢é€£ã®å•é¡Œ**

**å•é¡Œ1: ã‚¯ã‚¨ãƒªãŒé…ã„**
```sql
-- å•é¡Œã®ç‰¹å®š
EXPLAIN SELECT * FROM unified_logs WHERE user_id = 'USER001';
-- key: NULL â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½¿ã‚ã‚Œã¦ã„ãªã„

-- è§£æ±ºç­–: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
CREATE INDEX idx_unified_logs_user_id ON unified_logs(user_id);
```

**å•é¡Œ2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„**
```sql
-- âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„æ›¸ãæ–¹
SELECT * FROM hospitals WHERE UPPER(hospital_name) = 'ãƒ†ã‚¹ãƒˆç—…é™¢';

-- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãæ›¸ãæ–¹  
SELECT * FROM hospitals WHERE hospital_name = 'ãƒ†ã‚¹ãƒˆç—…é™¢';
```

#### **ãƒˆãƒªã‚¬ãƒ¼é–¢é€£ã®å•é¡Œ**

**å•é¡Œ1: ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒç•°å¸¸ã«é…ã„**
```sql
-- åŸå› ã®ç¢ºèª
SHOW TRIGGERS LIKE '%hospitals%';
-- â†’ å¤šã™ãã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚„ãƒˆãƒªã‚¬ãƒ¼å†…ã®é‡ã„å‡¦ç†ãŒåŸå› 

-- ä¸€æ™‚çš„ãªè§£æ±ºç­–ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ã¿ï¼‰
SET @disable_triggers = 1;  -- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã®åˆ¶å¾¡
```

**å•é¡Œ2: ãƒˆãƒªã‚¬ãƒ¼ã‚¨ãƒ©ãƒ¼ã§æ›´æ–°ã§ããªã„**
```sql
-- ã‚¨ãƒ©ãƒ¼è©³ç´°ã®ç¢ºèª
SHOW ENGINE INNODB STATUS;

-- ãƒˆãƒªã‚¬ãƒ¼å†…å®¹ã®ç¢ºèª
SHOW CREATE TRIGGER hospitals_update_audit;
```

#### **å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®å•é¡Œ**

**å•é¡Œ1: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãŒã§ããªã„**
```sql
-- å‚ç…§é–¢ä¿‚ã®ç¢ºèª
SELECT 
    CONSTRAINT_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM information_schema.KEY_COLUMN_USAGE 
WHERE REFERENCED_TABLE_NAME = 'hospitals';

-- å®‰å…¨ãªå‰Šé™¤é †åºã®ç¢ºèª
-- 1. å­ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆaddresses, contact_detailsï¼‰ã‹ã‚‰å‰Šé™¤
-- 2. è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆhospitalsï¼‰ã‚’å‰Šé™¤
```

**å•é¡Œ2: åˆ¶ç´„é•åã§ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ã§ããªã„**
```sql
-- å‚ç…§å…ˆãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
SELECT COUNT(*) FROM hospitals WHERE hospital_id = 'H001';
-- â†’ 0ã®å ´åˆã€hospital_idãŒå­˜åœ¨ã—ãªã„

-- æ­£ã—ã„é †åºã§ã®ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
INSERT INTO hospitals (...) VALUES (...);  -- å…ˆã«è¦ªãƒ‡ãƒ¼ã‚¿
INSERT INTO addresses (...) VALUES (...);  -- å¾Œã§å­ãƒ‡ãƒ¼ã‚¿
```

### ğŸ” **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰é›†**

```sql
-- 1. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.TABLES 
WHERE table_schema = 'newhptldb'
ORDER BY (data_length + index_length) DESC;

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨çŠ¶æ³
SELECT 
    table_name,
    index_name,
    cardinality,
    sub_part,
    packed,
    nullable,
    index_type
FROM information_schema.STATISTICS 
WHERE table_schema = 'newhptldb'
ORDER BY table_name, index_name;

-- 3. ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®ç›£è¦–è¨­å®š
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- 4. ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ï¼ˆãƒ­ãƒƒã‚¯èª¿æŸ»ç”¨ï¼‰
SHOW FULL PROCESSLIST;

-- 5. InnoDBã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè©³ç´°è¨ºæ–­ç”¨ï¼‰
SHOW ENGINE INNODB STATUS;
```

### ğŸ› ï¸ **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç”¨ã‚³ãƒãƒ³ãƒ‰é›†**

```sql
-- 1. ãƒˆãƒªã‚¬ãƒ¼ã®ä¸€æ™‚ç„¡åŠ¹åŒ–ï¼ˆç·Šæ€¥æ™‚ï¼‰
RENAME TABLE hospitals TO hospitals_backup;
CREATE TABLE hospitals LIKE hospitals_backup;
-- â†’ ãƒˆãƒªã‚¬ãƒ¼ã¯æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„

-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰
ALTER TABLE unified_logs DROP INDEX idx_unified_logs_created_at;
ALTER TABLE unified_logs ADD INDEX idx_unified_logs_created_at (created_at);

-- 3. ãƒ†ãƒ¼ãƒ–ãƒ«æœ€é©åŒ–
ANALYZE TABLE hospitals, unified_logs, inquires;
OPTIMIZE TABLE hospitals, unified_logs, inquires;

-- 4. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®ç¢ºèª
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME,
    UPDATE_RULE,
    DELETE_RULE
FROM information_schema.KEY_COLUMN_USAGE 
WHERE CONSTRAINT_SCHEMA = 'newhptldb' 
  AND REFERENCED_TABLE_NAME IS NOT NULL
ORDER BY TABLE_NAME, CONSTRAINT_NAME;
```

---

## é‹ç”¨ãƒ»ä¿å®ˆã‚¬ã‚¤ãƒ‰

### ğŸ”„ æ—¥å¸¸çš„ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

#### ãƒ­ã‚°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
```sql
-- 90æ—¥ä»¥ä¸Šå‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’å‰Šé™¤
DELETE FROM unified_logs 
WHERE log_type = 'access' 
  AND created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- ç›£æŸ»ãƒ­ã‚°ã¯1å¹´é–“ä¿æŒï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯æ°¸ç¶šä¿æŒï¼‰
DELETE FROM unified_logs 
WHERE log_type = 'audit' 
  AND created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
ANALYZE TABLE hospitals, unified_logs, introductions;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
OPTIMIZE TABLE hospitals, unified_logs, introductions;
```

### ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

#### ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®ç¢ºèª
```sql
-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ã®æœ‰åŠ¹åŒ–
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- å®Ÿè¡Œæ™‚é–“ã®é•·ã„ã‚¯ã‚¨ãƒªã‚’ç‰¹å®š
SHOW PROCESSLIST;
```

#### ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
```sql
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb
FROM information_schema.TABLES 
WHERE table_schema = 'newhptldb'
ORDER BY (data_length + index_length) DESC;
```

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–

#### ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ã®æ¤œå‡º
```sql
-- çŸ­æ™‚é–“ã§ã®å¤§é‡ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’æ¤œå‡º
SELECT 
    ip_address,
    COUNT(*) as attempts,
    MIN(created_at) as first_attempt,
    MAX(created_at) as last_attempt
FROM unified_logs 
WHERE log_type = 'security' 
  AND event_type = 'login_failure'
  AND created_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY ip_address
HAVING attempts >= 5
ORDER BY attempts DESC;
```

#### æ¨©é™å¤–ã‚¢ã‚¯ã‚»ã‚¹ã®ç›£è¦–
```sql
SELECT 
    user_id,
    event_type,
    target_resource,
    description,
    created_at
FROM unified_logs 
WHERE log_type = 'security' 
  AND event_type = 'permission_denied'
  AND created_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY created_at DESC;
```

### ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

#### å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
# å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump -u root -p newhptldb > newhptldb_backup_$(date +%Y%m%d).sql

# ãƒ†ãƒ¼ãƒ–ãƒ«åˆ¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆé‡è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ï¼‰
mysqldump -u root -p newhptldb hospitals unified_logs system_versions > critical_tables_backup.sql
```

#### ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ å¾©æ—§
```bash
# ãƒã‚¤ãƒŠãƒªãƒ­ã‚°ã‚’ä½¿ç”¨ã—ãŸå¾©æ—§
mysqlbinlog --start-datetime="2024-01-01 00:00:00" \
            --stop-datetime="2024-01-01 12:00:00" \
            mysql-bin.000001 | mysql -u root -p newhptldb
```

---

## ğŸ“ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

#### 1. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚¨ãƒ©ãƒ¼
```sql
-- åˆ¶ç´„ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
SET FOREIGN_KEY_CHECKS = 0;
-- ãƒ‡ãƒ¼ã‚¿æ“ä½œ
SET FOREIGN_KEY_CHECKS = 1;
```

#### 2. ãƒ­ãƒƒã‚¯å¾…æ©Ÿã®è§£æ±º
```sql
-- ç¾åœ¨ã®ãƒ­ãƒƒã‚¯çŠ¶æ³ã‚’ç¢ºèª
SHOW ENGINE INNODB STATUS;

-- ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç‰¹å®šãƒ»çµ‚äº†
SHOW PROCESSLIST;
KILL [process_id];
```

#### 3. å®¹é‡ä¸è¶³ã¸ã®å¯¾å¿œ
```sql
-- ä¸è¦ãªãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
CALL cleanup_old_logs();

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®åœ§ç¸®
ALTER TABLE unified_logs ENGINE=InnoDB;
```

---

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ã®æ³¨æ„ç‚¹

1. **å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã¯LIMITã‚’ä½¿ç”¨**
```sql
-- æ‚ªã„ä¾‹
SELECT * FROM unified_logs WHERE log_type = 'access';

-- è‰¯ã„ä¾‹
SELECT * FROM unified_logs WHERE log_type = 'access' 
ORDER BY created_at DESC LIMIT 1000;
```

2. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸæ¤œç´¢**
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãæ¤œç´¢
SELECT * FROM hospitals WHERE status = 'active';

-- å‰æ–¹ä¸€è‡´ã§ã®æ¤œç´¢
SELECT * FROM hospitals WHERE hospital_name LIKE 'å²¡å±±%';
```

3. **JOINã®æœ€é©åŒ–**
```sql
-- å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿é¸æŠ
SELECT h.hospital_name, ht.type_name
FROM hospitals h
JOIN hospital_types ht ON h.hospital_type_id = ht.type_id
WHERE h.status = 'active';
```

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¶­æŒ

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é©åˆ‡ã«ä½¿ç”¨
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’æ´»ç”¨
- ç›£æŸ»ãƒ­ã‚°ã§å¤‰æ›´å±¥æ­´ã‚’è¿½è·¡
- å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

---

## ğŸ”— é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

- [DBæ§‹é€ æ¡ˆ.md](./DBæ§‹é€ æ¡ˆ.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆä»•æ§˜æ›¸
- [newhptldb_schema.sql](./newhptldb_schema.sql) - å®Ÿéš›ã®ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«
- ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆåˆ¥é€”æä¾›ï¼‰

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2024å¹´1æœˆ24æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0  
**ä½œæˆè€…**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 