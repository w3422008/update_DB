# 新医療機関システム ガイド

## ディレクトリ構成と役割

### 📁 ルートレベル

| ファイル/フォルダ | 役割                                                                |
| ----------------- | ------------------------------------------------------------------- |
| `index.php`       | エントリーポイント。リクエストを `public/router.php` にリダイレクト |
| `config/`         | アプリケーション設定ファイル                                        |
| `app/`            | ビジネスロジック・コントローラー・モデル                            |
| `public/`         | Webサーバーの公開ディレクトリ（CSS、JS、ルーター）                  |
| `routes/`         | ルーティング定義                                                    |
| `storage/`        | アップロードファイルなどの保存ディレクトリ                          |

---

### 🔧 config/

**用途**: アプリケーションの設定値を管理

| ファイル     | 役割                                                                                 |
| ------------ | ------------------------------------------------------------------------------------ |
| `config.php` | `BASE_PATH`、`ASSETS_PATH`などの定数定義とヘルパー関数（`route()`、`asset()`）を定義 |

---

### 🚀 public/

**用途**: Webサーバーの公開ディレクトリ。ブラウザからアクセスされる静的ファイルとAPIエンドポイント

| ファイル/フォルダ        | 役割                                                                            |
| ------------------------ | ------------------------------------------------------------------------------- |
| `router.php`             | シンプルなルーティング処理。`REQUEST_URI`を解析して該当コントローラーを呼び出す |
| `css/`                   | スタイルシート                                                                  |
| `css/AppCore.css`        | 全ページ共通スタイル（ナビゲーション、バッジ、メニューなど）                    |
| `css/login.css`          | ログイン画面専用スタイル                                                        |
| `js/`                    | JavaScriptファイル                                                              |
| `js/login/login_auth.js` | ログインフォーム処理。フォーム送信をAPIにPOSTで送信                             |
| `js/links/links.js`      | API URLなどのリンク定義を一元管理                                               |
| `images/favicon/`        | ファビコンなどの画像資産                                                        |

---

### 🛣️ routes/

**用途**: URLパターンとコントローラー・メソッドをマッピング

| ファイル  | 役割                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------ |
| `web.php` | ルート定義。`'/' => ['controller' => 'LoginController', 'method' => 'login']` のような形式で管理 |

---

### 📱 app/

**用途**: MVC のビジネスロジック層

#### Controllers/

コントローラークラス。HTTPリクエストを処理してビューを返す

| ファイル                     | 役割                                                            |
| ---------------------------- | --------------------------------------------------------------- |
| `LoginController.php`        | ログイン画面の表示（`login` メソッド）                          |
| `HomeController.php`         | ホーム画面の表示（`home` メソッド）                             |
| `UserController.php`         | ユーザープロフィール画面の表示（`profile` メソッド）            |
| `api/LoginApiController.php` | ログイン認証APIエンドポイント。JSからPOST受付して認証処理を実行 |

#### Models/

データベース操作やビジネスロジック

| ファイル              | 役割                                                                                    |
| --------------------- | --------------------------------------------------------------------------------------- |
| `AppCore.php`         | コア機能を統一管理（DB接続初期化、セッション管理、HTMLエスケープ、ユーザー情報取得）    |
| `LoginManager.php`    | ログイン認証・レートリミット・セッション管理。認証成功/失敗の判定とセッション設定を行う |
| `LogAuditManager.php` | ログ・監査記録管理。`unified_logs`テーブルにログイン/ログアウト/監査情報を一元記録      |
| `User.php`            | ユーザーデータの簡単なモデル（id、name、email プロパティ）                              |
| `Product.php`         | 製品データモデル（未使用）                                                              |

#### Services/

ビジネスロジックの上位層。コントローラーと Models の仲介役

| ファイル          | 役割                                                   |
| ----------------- | ------------------------------------------------------ |
| `UserService.php` | ユーザーデータ取得ロジック（`getUserData()` メソッド） |

#### Repositories/

データベースアクセスの共通化

| ファイル               | 役割                                                           |
| ---------------------- | -------------------------------------------------------------- |
| `UserRepository.php`   | ユーザー関連のDB操作（現在は `findById()` で模擬データを返す） |
| `CommonRepository.php` | DB接続の共通ロジック（実装されているが現在は使用されていない） |

#### Views/

HTMLテンプレート

| フォルダ | ファイル         | 役割                                                            |
| -------- | ---------------- | --------------------------------------------------------------- |
| `login/` | `login_view.php` | ログイン画面のHTML。フォーム送信で `login_auth.js` の処理を実行 |
| `home/`  | `home_view.php`  | ホーム画面のHTML                                                |
| `user/`  | `profile.php`    | ユーザープロフィール画面のHTML                                  |

---

### 📦 storage/

**用途**: アップロードファイルやログファイルなどの保存場所

| ファイル     | 役割                                  |
| ------------ | ------------------------------------- |
| `.gitignore` | このディレクトリをGit追跡対象外に指定 |

---

## 環境に合わせて変更が必要な点

### 1. `config/config.php` の `BASE_PATH`

ローカル環境のパスに合わせて修正

```php
// ベースパスを定義
$basePath = '/{ }/hospital_system/public';
```

※｛ ｝内へ、あてはまるパスを入れることで動作するようになる
→ hospital_systemフォルダが「rebuild/edit」の中に入っている場合は以下のように記述する

```php
// ベースパスを定義
$basePath = '/rebuild/edit/hospital_system/public';
```

### 2. `public/js/links/links.js` の `LOGIN_API_URL`

ローカル環境のAPIエンドポイント URLに合わせて修正

```js
export const LOGIN_API_URL =
  "http://localhost:8080/revision/hospital_system/app/Controllers/api/LoginApiController.php";
```

### 3. `app/Models/AppCore.php` の DB接続設定

環境変数またはハードコード値で DB接続情報を指定

```php
$host = getenv('DB_HOST') ?: 'localhost';
$db   = getenv('DB_DATABASE') ?: 'newhptldb';
$user = getenv('DB_USERNAME') ?: 'root';
$pass = getenv('DB_PASSWORD') ?: '';
```

---
